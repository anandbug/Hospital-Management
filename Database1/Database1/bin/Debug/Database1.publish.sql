/*
Deployment script for Database1

This code was generated by a tool.
Changes to this file may cause incorrect behavior and will be lost if
the code is regenerated.
*/

GO
SET ANSI_NULLS, ANSI_PADDING, ANSI_WARNINGS, ARITHABORT, CONCAT_NULL_YIELDS_NULL, QUOTED_IDENTIFIER ON;

SET NUMERIC_ROUNDABORT OFF;


GO
:setvar DatabaseName "Database1"
:setvar DefaultFilePrefix "Database1"
:setvar DefaultDataPath "C:\Users\Dhyan\AppData\Local\Microsoft\VisualStudio\SSDT\"
:setvar DefaultLogPath "C:\Users\Dhyan\AppData\Local\Microsoft\VisualStudio\SSDT\"

GO
:on error exit
GO
/*
Detect SQLCMD mode and disable script execution if SQLCMD mode is not supported.
To re-enable the script after enabling SQLCMD mode, execute the following:
SET NOEXEC OFF; 
*/
:setvar __IsSqlCmdEnabled "True"
GO
IF N'$(__IsSqlCmdEnabled)' NOT LIKE N'True'
    BEGIN
        PRINT N'SQLCMD mode must be enabled to successfully execute this script.';
        SET NOEXEC ON;
    END


GO
IF EXISTS (SELECT 1
           FROM   [master].[dbo].[sysdatabases]
           WHERE  [name] = N'$(DatabaseName)')
    BEGIN
        ALTER DATABASE [$(DatabaseName)]
            SET ARITHABORT ON,
                CONCAT_NULL_YIELDS_NULL ON,
                CURSOR_DEFAULT LOCAL 
            WITH ROLLBACK IMMEDIATE;
    END


GO
IF EXISTS (SELECT 1
           FROM   [master].[dbo].[sysdatabases]
           WHERE  [name] = N'$(DatabaseName)')
    BEGIN
        ALTER DATABASE [$(DatabaseName)]
            SET PAGE_VERIFY NONE,
                DISABLE_BROKER 
            WITH ROLLBACK IMMEDIATE;
    END


GO
USE [$(DatabaseName)];


GO
PRINT N'Rename refactoring operation with key af742833-30f4-447d-925a-35d7e73d1781 is skipped, element [dbo].[patient].[Id] (SqlSimpleColumn) will not be renamed to pid';


GO
PRINT N'Rename refactoring operation with key 6fd09723-047d-40dc-a23b-58c2a6412f35, 2b149704-9488-467c-a563-2e091fb2493c is skipped, element [dbo].[appointment].[Id] (SqlSimpleColumn) will not be renamed to anum';


GO
PRINT N'Rename refactoring operation with key 397e373e-8e1d-4f78-b673-75716ff74058 is skipped, element [dbo].[doctor].[Id] (SqlSimpleColumn) will not be renamed to did';


GO
PRINT N'Rename refactoring operation with key fca0f24e-5fa3-4d6f-bf7a-d89d9534be70 is skipped, element [dbo].[FK_patient_ToTable] (SqlForeignKeyConstraint) will not be renamed to [doctor]';


GO
PRINT N'Creating [dbo].[doctor]...';


GO
CREATE TABLE [dbo].[doctor] (
    [did]    INT            NOT NULL,
    [name]   NVARCHAR (50)  NOT NULL,
    [charge] MONEY          NOT NULL,
    [dep]    NVARCHAR (50)  NOT NULL,
    [desc]   NVARCHAR (MAX) NOT NULL,
    [sex]    NCHAR (10)     NOT NULL,
    PRIMARY KEY CLUSTERED ([did] ASC)
);


GO
PRINT N'Creating [dbo].[patient]...';


GO
CREATE TABLE [dbo].[patient] (
    [pid]     INT           NOT NULL,
    [sex]     NCHAR (10)    NOT NULL,
    [name]    NVARCHAR (50) NOT NULL,
    [address] NVARCHAR (50) NOT NULL,
    [age]     INT           NOT NULL,
    [did]     INT           NOT NULL,
    [anum]    INT           NOT NULL,
    PRIMARY KEY CLUSTERED ([pid] ASC)
);


GO
PRINT N'Creating dbo.appointment...';


GO
ALTER TABLE [dbo].[patient] WITH NOCHECK
    ADD CONSTRAINT [dbo.appointment] FOREIGN KEY ([anum]) REFERENCES [dbo].[appointment] ([anum]);


GO
PRINT N'Creating dbo.doctor...';


GO
ALTER TABLE [dbo].[patient] WITH NOCHECK
    ADD CONSTRAINT [dbo.doctor] FOREIGN KEY ([did]) REFERENCES [dbo].[doctor] ([did]);


GO
PRINT N'Altering [dbo].[persistappointment]...';


GO
ALTER PROCEDURE [dbo].[persistappointment]

AS
	INSERT into dbo.appointment (anum,timings,daignosis,nextmeet,charge,did) values('1', '2013-08-30 10:00:00', 'kill him', '2013-09-10 10:00:00', '200', '2');
	SELECT *
	FROM dbo.appointment;
RETURN 0
GO
-- Refactoring step to update target server with deployed transaction logs

IF OBJECT_ID(N'dbo.__RefactorLog') IS NULL
BEGIN
    CREATE TABLE [dbo].[__RefactorLog] (OperationKey UNIQUEIDENTIFIER NOT NULL PRIMARY KEY)
    EXEC sp_addextendedproperty N'microsoft_database_tools_support', N'refactoring log', N'schema', N'dbo', N'table', N'__RefactorLog'
END
GO
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = 'af742833-30f4-447d-925a-35d7e73d1781')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('af742833-30f4-447d-925a-35d7e73d1781')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = '6fd09723-047d-40dc-a23b-58c2a6412f35')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('6fd09723-047d-40dc-a23b-58c2a6412f35')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = '2b149704-9488-467c-a563-2e091fb2493c')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('2b149704-9488-467c-a563-2e091fb2493c')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = '397e373e-8e1d-4f78-b673-75716ff74058')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('397e373e-8e1d-4f78-b673-75716ff74058')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = 'fca0f24e-5fa3-4d6f-bf7a-d89d9534be70')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('fca0f24e-5fa3-4d6f-bf7a-d89d9534be70')

GO

GO
PRINT N'Checking existing data against newly created constraints';


GO
USE [$(DatabaseName)];


GO
ALTER TABLE [dbo].[patient] WITH CHECK CHECK CONSTRAINT [dbo.appointment];

ALTER TABLE [dbo].[patient] WITH CHECK CHECK CONSTRAINT [dbo.doctor];


GO
PRINT N'Update complete.';


GO
